# Вступление

rsnapshot — утилита на базе rsync, создающая инкрементные бэкапы. Файлы без изменений заменяются на жесткие ссылки, изменённые файлы — добавляются в бэкап. Каждый бэкап независим и занимает место только за счёт измененых файлов. 


# Особенности скрипта:

- запускается на стороне backup сервера
- формируется независимый rsnapshot.conf ( правки в конфиг вносятся в теле скрипта)
- на всех этапах скрипта присутствуют хэндлеры ошибок
- добавлено дополнительное логирование ( в случае ошибки)
- добавлено оповещение через телеграм ( в случае ошибки)
- после бэкапирования происходит проверка целостности на базе контрольных сумм 
- предустановлены флаги --type daily (30), --type monthly (12)


# ENV & CONSTS

| CONST | Описание |
|---|---|
| SSH_PATH | Откуда бэкапим |
| SNAPSHOT_ROOT | Куда бэкапим |
| SSH_USER | Кто бэкапит |
| SSH_SERVER | С какого сервера бэкапим ( обязательно в формате IP addr) |
| TELEGRAM_TOKEN | Token бота для отправки пушапов
| TELEGRAM_ID | Id чата или пользователя для получения пушапов
| RSNAPSHOT_TYPE | daily или monthly - интервалы из конфига |


# Быстрый старт

- создать пользователя который будет выполнять бэкапы
- сгенерировать пару ключей
- положить публичный ключ на target server
- сохранить скрипт на backup сервере
- chmod +x /path/to/script.sh
- заполнить константы в скрипте
- для первого запуска лучше выполнить скрипт вручную, чтобы лучше контролировать процесс.
- добавить в cron соответствующие задания



# Cron 

```bash
# пример ежедневного backup в 1:00 AM
0 1 * * * /path/to/script.sh --type daily

# пример ежемесячного backup в 4:00 AM
0 4 1 * * /path/to/script.sh --type monthly
```
